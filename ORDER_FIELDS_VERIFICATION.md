# Order Fields Verification Report

## Summary
All required order fields are now properly captured and saved to the database during checkout. Below is a detailed breakdown of where each field is set and saved.

## Required Fields Status

### ✅ 1. order_id
- **Status**: ✅ Automatically generated
- **Location**: Database AUTO_INCREMENT
- **File**: `db/create_orders_tables.php` (line 16)
- **Details**: Unique identifier automatically generated by MySQL when a new order is inserted

### ✅ 2. customer_id
- **Status**: ✅ Captured and saved
- **Location**: Set during order creation
- **File**: `class/order_class.php` - `create_order()` method (line 119)
- **Details**: 
  - Validated before order creation (lines 23-26)
  - Passed as parameter to `create_order()` method
  - Saved in INSERT statement (line 119 in params array)

### ✅ 3. invoice_no
- **Status**: ✅ Generated and saved
- **Location**: Generated during order creation, optionally updated during payment
- **File**: `class/order_class.php`
  - **Generation**: `generate_invoice_no()` method (lines 15-35)
  - **Saving**: `create_order()` method (line 119 in params array)
  - **Update**: `update_order_complete()` method (line 536) - updates with payment reference
- **Format**: `INV-YYYYMMDD-HHMMSS-XXXXX` (e.g., INV-20241215-143022-12345)
- **Details**: 
  - Initially generated with unique format during order creation
  - Updated with Paystack payment reference during payment verification (if provided)
  - Ensured uniqueness by checking database before assignment

### ✅ 4. order_date
- **Status**: ✅ Captured and saved
- **Location**: Set during order creation
- **File**: `class/order_class.php` - `create_order()` method (line 121)
- **Details**: 
  - Set to current timestamp: `date('Y-m-d H:i:s')`
  - Saved in INSERT statement (line 119 in params array)
  - Uses proper MySQL TIMESTAMP format
  - **NOT updated** during payment verification (preserves original order creation time)

### ✅ 5. order_status
- **Status**: ✅ Set and saved
- **Location**: Set during order creation, updated during payment
- **File**: `class/order_class.php`
  - **Initial**: `create_order()` method (line 123) - set to 'pending'
  - **Update**: `update_order_complete()` method (line 530) - updated to 'completed' after payment
- **Details**: 
  - Initial value: `'pending'` (set during order creation)
  - Updated to `'completed'` after successful payment verification
  - Valid statuses: 'pending', 'processing', 'shipped', 'delivered', 'cancelled', 'completed', 'paid'

## Database Schema Updates

### Orders Table Structure
The orders table now includes all required fields:

```sql
CREATE TABLE orders (
    order_id INT(11) NOT NULL AUTO_INCREMENT,        -- ✅ Unique identifier
    customer_id INT(11) NOT NULL,                    -- ✅ Customer ID
    invoice_no VARCHAR(50) DEFAULT NULL,            -- ✅ Invoice number (UNIQUE)
    total_amount DECIMAL(10,2) NOT NULL,
    shipping_address TEXT NOT NULL,
    payment_method VARCHAR(50) DEFAULT 'pending',
    order_status VARCHAR(50) DEFAULT 'pending',     -- ✅ Order status
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- ✅ Order date
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (order_id),
    UNIQUE KEY idx_invoice_no (invoice_no),
    ...
)
```

## Code Flow

### Order Creation Flow (checkout.php → checkout_action.php → order_controller.php → order_class.php)

1. **checkout.php** (Frontend)
   - Displays checkout page
   - Initiates payment via Paystack

2. **checkout_action.php** (if direct checkout without Paystack)
   - Calls `create_order_ctr()` with customer_id and cart items
   - All fields are captured at this stage

3. **order_controller.php** - `create_order_ctr()`
   - Validates items and calculates total
   - Calls `order_class->create_order()`

4. **order_class.php** - `create_order()`
   - **Generates invoice_no** (line 121)
   - **Sets order_date** (line 123)
   - **Sets order_status** to 'pending' (line 125)
   - **Saves customer_id** (line 119)
   - **INSERTs all fields** into database (lines 115-119)

### Payment Verification Flow (paystack_callback.php → paystack_verify_payment.php)

1. **paystack_callback.php** (Frontend)
   - Receives payment reference from Paystack
   - Calls verification endpoint

2. **paystack_verify_payment.php**
   - Verifies payment with Paystack API
   - Creates order (if not already created) - **all fields saved here**
   - Updates order with payment reference as invoice_no
   - Updates order_status to 'completed'
   - **order_date remains unchanged** (preserves original creation time)

## Key Code Locations

### Order Creation (All Fields Saved)
**File**: `class/order_class.php`
**Method**: `create_order()`
**Lines**: 115-119

```php
// INSERT statement with ALL required fields:
// - customer_id: ID of the customer placing the order
// - invoice_no: Unique invoice/receipt number
// - total_amount: Total order amount
// - shipping_address: Shipping address
// - payment_method: Payment method used
// - order_status: Initial status (pending)
// - order_date: Timestamp when order was placed
$sql = "INSERT INTO orders 
        (customer_id, invoice_no, total_amount, shipping_address, payment_method, order_status, order_date)
        VALUES (?, ?, ?, ?, ?, ?, ?)";

$params = [
    (int)$customer_id,           // customer_id: ID of the customer placing the order
    $invoice_no,                 // invoice_no: Unique invoice/receipt number
    (float)$total_amount,        // total_amount: Total order amount
    $shipping_address,           // shipping_address: Shipping address
    $payment_method,             // payment_method: Payment method used
    $order_status,                // order_status: Initial status (pending)
    $order_date                   // order_date: Timestamp when order was placed
];
```

### Invoice Number Generation
**File**: `class/order_class.php`
**Method**: `generate_invoice_no()`
**Lines**: 15-35

```php
/**
 * Generate unique invoice number
 * Format: INV-YYYYMMDD-HHMMSS-XXXXX (where XXXXX is a random 5-digit number)
 */
private function generate_invoice_no() {
    $prefix = 'INV';
    $date_part = date('Ymd-His');
    $random_part = str_pad(rand(0, 99999), 5, '0', STR_PAD_LEFT);
    $invoice_no = $prefix . '-' . $date_part . '-' . $random_part;
    
    // Ensures uniqueness by checking database
    // ...
}
```

### Payment Verification Update
**File**: `actions/paystack_verify_payment.php`
**Lines**: 218-221

```php
// 4. Update order status to completed and set invoice_no to payment reference
// This updates:
// - invoice_no: Set to payment reference (Paystack transaction reference)
// - order_status: Set to 'completed'
// Note: order_date and customer_id remain unchanged (set during order creation)
$order->update_order_complete($order_id, $reference, 'completed');
```

## Verification Checklist

- ✅ **order_id**: Auto-generated by database (AUTO_INCREMENT)
- ✅ **customer_id**: Captured from session, validated, and saved during INSERT
- ✅ **invoice_no**: Generated uniquely during order creation, optionally updated with payment reference
- ✅ **order_date**: Set to current timestamp during order creation, preserved throughout
- ✅ **order_status**: Set to 'pending' initially, updated to 'completed' after payment

## Database Migration

If you have an existing orders table, run the migration script:
- **File**: `db/create_orders_tables.php`
- The script automatically adds `invoice_no` and `order_date` columns if they don't exist (lines 37-50)

## Testing Recommendations

1. **Test Order Creation**: Create a new order and verify all fields are saved
2. **Test Invoice Uniqueness**: Create multiple orders quickly and verify invoice numbers are unique
3. **Test Payment Flow**: Complete a Paystack payment and verify:
   - invoice_no is updated with payment reference
   - order_status is updated to 'completed'
   - order_date remains the original creation timestamp
4. **Database Verification**: Query the orders table to confirm all fields are populated:
   ```sql
   SELECT order_id, customer_id, invoice_no, order_date, order_status 
   FROM orders 
   ORDER BY order_id DESC 
   LIMIT 10;
   ```

## Notes

- **order_date** is set once during order creation and never updated, preserving the original order timestamp
- **invoice_no** is initially generated with a unique format, then optionally updated with the payment reference for payment tracking
- All fields are validated before insertion to ensure data integrity
- The database schema includes proper indexes for performance on frequently queried fields

